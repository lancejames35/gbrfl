<%- contentFor('head') %>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="/css/scoreboard.css" rel="stylesheet">

<%- contentFor('body') %>
<div class="scoreboard-container">
  <!-- Navigation Header -->
  <div class="scoreboard-nav">
    <div class="container-fluid">
      <div class="row align-items-center">
        <div class="col-md-8">
          <div class="row">
            <div class="col-md-3">
              <label for="season" class="form-label text-white">Season</label>
              <select class="form-select form-select-sm" id="season" name="season" onchange="updateScoreboard()">
                <% seasons.forEach(s => { %>
                  <option value="<%= s %>" <%= s == season ? 'selected' : '' %>><%= s %></option>
                <% }); %>
              </select>
            </div>
            
            <div class="col-md-3">
              <label for="week" class="form-label text-white">Week</label>
              <select class="form-select form-select-sm" id="week" name="week" onchange="updateScoreboard()">
                <% weeks.forEach(w => { %>
                  <option value="<%= w %>" <%= w == week ? 'selected' : '' %>>Week <%= w %></option>
                <% }); %>
              </select>
            </div>
            
            <div class="col-md-3">
              <label for="gameType" class="form-label text-white">Game Type</label>
              <select class="form-select form-select-sm" id="gameType" name="gameType" onchange="updateScoreboard()">
                <% gameTypes.forEach(gt => { %>
                  <option value="<%= gt %>" <%= gt == gameType ? 'selected' : '' %>><%= gt.charAt(0).toUpperCase() + gt.slice(1) %></option>
                <% }); %>
              </select>
            </div>
            
            <div class="col-md-3">
              <label for="viewTeam" class="form-label text-white">View Team</label>
              <select class="form-select form-select-sm" id="viewTeam" name="viewTeam">
                <option value="">All Matchups</option>
                <% teams.forEach(team => { %>
                  <option value="<%= team.team_id %>"><%= team.team_name %></option>
                <% }); %>
              </select>
            </div>
          </div>
        </div>
        
        <div class="col-md-4 text-end">
          <button class="btn btn-outline-light btn-sm" onclick="refreshScoreboard()">
            <i class="fas fa-refresh"></i> Refresh
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="container-fluid mt-4">
    <div class="row">
      
      <!-- Standings Sidebar -->
      <div class="col-md-3">
        <div class="card">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">League Standings</h5>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
              <table class="table table-sm table-hover mb-0">
                <thead class="sticky-top bg-light">
                  <tr>
                    <th>#</th>
                    <th>Team</th>
                    <th>Record</th>
                    <th>PF</th>
                  </tr>
                </thead>
                <tbody>
                  <% if (standings && standings.length > 0) { %>
                    <% standings.forEach((team, index) => { %>
                      <tr>
                        <td><%= index + 1 %></td>
                        <td class="text-truncate" style="max-width: 120px;">
                          <%= team.team_name %>
                        </td>
                        <td><%= team.wins %>-<%= team.losses %><%= team.ties > 0 ? `-${team.ties}` : '' %></td>
                        <td><%= parseFloat(team.points_for).toFixed(1) %></td>
                      </tr>
                    <% }); %>
                  <% } else { %>
                    <tr><td colspan="4" class="text-center text-muted">No data available</td></tr>
                  <% } %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Matchups Main Area -->
      <div class="col-md-9">
        <div class="card">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0">Week <%= week %> Matchups - <%= gameType.charAt(0).toUpperCase() + gameType.slice(1) %> Games</h5>
          </div>
          <div class="card-body">
            <div id="matchups-container">
              <% if (matchups && matchups.length > 0) { %>
                <% matchups.forEach(matchup => { %>
                  <div class="matchup-card mb-4 p-3 border rounded">
                    <div class="row align-items-center">
                      <div class="col-md-5">
                        <div class="team-info <%= matchup.winner == 'team1' ? 'winner' : '' %>">
                          <h6 class="mb-1"><%= matchup.team1_name %></h6>
                          <small class="text-muted"><%= matchup.team1_owner %></small>
                          <div class="score-display mt-2">
                            <span class="h4"><%= parseFloat(matchup.team1_final_score).toFixed(1) %></span>
                            <% if (matchup.team1_bonus > 0) { %>
                              <span class="badge bg-warning ms-2">+<%= matchup.team1_bonus %> bonus</span>
                            <% } %>
                          </div>
                          <div class="score-breakdown">
                            <small class="text-muted">H2H: <%= matchup.team1_score %> | Bonus: <%= matchup.team1_bonus %></small>
                          </div>
                        </div>
                      </div>
                      
                      <div class="col-md-2 text-center">
                        <div class="vs-section">
                          <div class="vs-circle">
                            <span class="vs-text">VS</span>
                          </div>
                        </div>
                      </div>
                      
                      <div class="col-md-5">
                        <div class="team-info text-end <%= matchup.winner == 'team2' ? 'winner' : '' %>">
                          <h6 class="mb-1"><%= matchup.team2_name %></h6>
                          <small class="text-muted"><%= matchup.team2_owner %></small>
                          <div class="score-display mt-2 justify-content-end">
                            <span class="h4"><%= parseFloat(matchup.team2_final_score).toFixed(1) %></span>
                            <% if (matchup.team2_bonus > 0) { %>
                              <span class="badge bg-warning ms-2">+<%= matchup.team2_bonus %> bonus</span>
                            <% } %>
                          </div>
                          <div class="score-breakdown">
                            <small class="text-muted">H2H: <%= matchup.team2_score %> | Bonus: <%= matchup.team2_bonus %></small>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Category Summary -->
                    <% if (matchup.category_summary) { %>
                      <div class="category-summary mt-3 pt-3 border-top">
                        <small class="text-muted">Categories Won:</small>
                        <div class="progress mt-1" style="height: 20px;">
                          <% 
                          const summary = matchup.category_summary;
                          const total = summary.team1_categories_won + summary.team2_categories_won + summary.ties;
                          const team1Pct = total > 0 ? (summary.team1_categories_won / total) * 100 : 0;
                          const team2Pct = total > 0 ? (summary.team2_categories_won / total) * 100 : 0;
                          const tiesPct = total > 0 ? (summary.ties / total) * 100 : 0;
                          %>
                          <div class="progress-bar bg-primary" style="width: <%= team1Pct %>%">
                            <%= summary.team1_categories_won %>
                          </div>
                          <% if (summary.ties > 0) { %>
                            <div class="progress-bar bg-secondary" style="width: <%= tiesPct %>%">
                              <%= summary.ties %>
                            </div>
                          <% } %>
                          <div class="progress-bar bg-danger" style="width: <%= team2Pct %>%">
                            <%= summary.team2_categories_won %>
                          </div>
                        </div>
                      </div>
                    <% } %>
                    
                    <div class="mt-3">
                      <button class="btn btn-sm btn-outline-primary" 
                              onclick="viewMatchupDetail(<%= matchup.team1_id %>, <%= matchup.team2_id %>)">
                        View Details
                      </button>
                      <button class="btn btn-sm btn-outline-secondary" 
                              onclick="viewTeamBreakdown(<%= matchup.team1_id %>)">
                        <%= matchup.team1_name %> Breakdown
                      </button>
                      <button class="btn btn-sm btn-outline-secondary" 
                              onclick="viewTeamBreakdown(<%= matchup.team2_id %>)">
                        <%= matchup.team2_name %> Breakdown
                      </button>
                    </div>
                  </div>
                <% }); %>
              <% } else { %>
                <div class="alert alert-info">
                  <h5>No matchups found</h5>
                  <p class="mb-0">
                    No matchups are available for Week <%= week %> <%= gameType %> games.
                    <br>
                    This could mean:
                  </p>
                  <ul>
                    <li>No lineup submissions for this week</li>
                    <li>Schedule not set up for this week</li>
                    <li>No player stats available for this week</li>
                  </ul>
                </div>
              <% } %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Detail Modal -->
  <div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="detailModalTitle">Loading...</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="detailModalBody">
          <div class="text-center">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<%- contentFor('scripts') %>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const currentSeason = <%= season %>;
const currentWeek = <%= week %>;
const currentGameType = '<%= gameType %>';

function updateScoreboard() {
    const season = document.getElementById('season').value;
    const week = document.getElementById('week').value;
    const gameType = document.getElementById('gameType').value;
    
    const url = `/scoreboard?season=${season}&week=${week}&game_type=${gameType}`;
    window.location.href = url;
}

function refreshScoreboard() {
    window.location.reload();
}

function viewMatchupDetail(team1Id, team2Id) {
    const modal = new bootstrap.Modal(document.getElementById('detailModal'));
    modal.show();
    
    document.getElementById('detailModalTitle').textContent = 'Loading Matchup Details...';
    document.getElementById('detailModalBody').innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    `;
    
    fetch(`/api/scoreboard/matchup-detail?team1_id=${team1Id}&team2_id=${team2Id}&week=${currentWeek}&season=${currentSeason}&game_type=${currentGameType}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayMatchupDetail(data.data);
            } else {
                document.getElementById('detailModalBody').innerHTML = `
                    <div class="alert alert-danger">${data.error}</div>
                `;
            }
        })
        .catch(error => {
            document.getElementById('detailModalBody').innerHTML = `
                <div class="alert alert-danger">Failed to load matchup details: ${error.message}</div>
            `;
        });
}

function viewTeamBreakdown(teamId) {
    const modal = new bootstrap.Modal(document.getElementById('detailModal'));
    modal.show();
    
    document.getElementById('detailModalTitle').textContent = 'Loading Team Breakdown...';
    document.getElementById('detailModalBody').innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    `;
    
    fetch(`/api/scoreboard/team-breakdown?team_id=${teamId}&week=${currentWeek}&season=${currentSeason}&game_type=${currentGameType}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayTeamBreakdown(data.data);
            } else {
                document.getElementById('detailModalBody').innerHTML = `
                    <div class="alert alert-danger">${data.error}</div>
                `;
            }
        })
        .catch(error => {
            document.getElementById('detailModalBody').innerHTML = `
                <div class="alert alert-danger">Failed to load team breakdown: ${error.message}</div>
            `;
        });
}

function displayMatchupDetail(matchup) {
    document.getElementById('detailModalTitle').textContent = 
        `${matchup.team1_name} vs ${matchup.team2_name} - Week ${matchup.week}`;
    
    let html = '<div class="matchup-detail">';
    
    // Score summary
    html += `
        <div class="row mb-4">
            <div class="col-md-5 text-center">
                <h4>${matchup.team1_name}</h4>
                <h2 class="display-4">${matchup.team1_final_score.toFixed(1)}</h2>
                <p>H2H: ${matchup.team1_score} | Bonus: ${matchup.team1_bonus}</p>
            </div>
            <div class="col-md-2 text-center align-self-center">
                <span class="h3">vs</span>
            </div>
            <div class="col-md-5 text-center">
                <h4>${matchup.team2_name}</h4>
                <h2 class="display-4">${matchup.team2_final_score.toFixed(1)}</h2>
                <p>H2H: ${matchup.team2_score} | Bonus: ${matchup.team2_bonus}</p>
            </div>
        </div>
    `;
    
    // Category breakdown
    html += '<h5>Category Breakdown</h5>';
    html += '<div class="table-responsive"><table class="table table-sm">';
    html += '<thead><tr><th>Category</th><th>Stat</th><th>' + matchup.team1_name + '</th><th>' + matchup.team2_name + '</th><th>Points</th><th>Bonus</th></tr></thead>';
    html += '<tbody>';
    
    for (const [categoryName, stats] of Object.entries(matchup.category_results)) {
        for (const [statName, result] of Object.entries(stats)) {
            const winner = result.team1_wins === true ? 'team1' : (result.team1_wins === false ? 'team2' : 'tie');
            html += '<tr>';
            html += `<td>${categoryName}</td>`;
            html += `<td>${statName.replace(/_/g, ' ')}</td>`;
            html += `<td class="${winner === 'team1' ? 'table-success' : ''}">${result.team1_value}</td>`;
            html += `<td class="${winner === 'team2' ? 'table-success' : ''}">${result.team2_value}</td>`;
            html += `<td>${result.h2h_points}</td>`;
            html += '<td>';
            if (result.team1_bonus > 0) html += `<span class="badge bg-warning">${matchup.team1_name}: +${result.team1_bonus}</span> `;
            if (result.team2_bonus > 0) html += `<span class="badge bg-warning">${matchup.team2_name}: +${result.team2_bonus}</span>`;
            html += '</td>';
            html += '</tr>';
        }
    }
    
    html += '</tbody></table></div>';
    html += '</div>';
    
    document.getElementById('detailModalBody').innerHTML = html;
}

function displayTeamBreakdown(breakdown) {
    document.getElementById('detailModalTitle').textContent = 
        `${breakdown.team_info.team_name} - Week ${breakdown.week} Breakdown`;
    
    let html = '<div class="team-breakdown">';
    
    // Team stats summary
    html += '<h5>Team Statistics</h5>';
    html += '<div class="row mb-4">';
    
    // Display aggregated stats
    const categories = ['passing', 'rushing', 'receiving', 'kicking', 'defense'];
    for (const category of categories) {
        if (breakdown.team_stats[category]) {
            html += '<div class="col-md-4 mb-3">';
            html += `<div class="card"><div class="card-header bg-light"><strong>${category.charAt(0).toUpperCase() + category.slice(1)}</strong></div>`;
            html += '<div class="card-body"><ul class="list-unstyled mb-0">';
            
            const stats = breakdown.team_stats[category];
            for (const [key, value] of Object.entries(stats)) {
                if (typeof value === 'number') {
                    html += `<li><small>${key.replace(/_/g, ' ')}: ${value.toFixed(1)}</small></li>`;
                }
            }
            
            html += '</ul></div></div></div>';
        }
    }
    
    html += '</div>';
    html += '</div>';
    
    document.getElementById('detailModalBody').innerHTML = html;
}
</script>