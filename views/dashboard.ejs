<!-- Enhanced CSS for Dashboard -->
<style>
    .stat-block {
        padding: 1.25rem;
        border-radius: 12px;
        background: linear-gradient(135deg, rgba(13, 110, 253, 0.08), rgba(13, 110, 253, 0.03));
        transition: all 0.3s ease;
        cursor: pointer;
        border: 1px solid rgba(13, 110, 253, 0.15);
        position: relative;
        overflow: hidden;
    }

    .stat-block::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #0d6efd, #6610f2);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .stat-block:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 25px rgba(13, 110, 253, 0.2);
        background: linear-gradient(135deg, rgba(13, 110, 253, 0.12), rgba(13, 110, 253, 0.06));
        border-color: rgba(13, 110, 253, 0.3);
    }

    .stat-block:hover::before {
        opacity: 1;
    }

    .news-item {
        transition: all 0.2s ease;
        padding: 1rem;
        border-radius: 8px;
        margin: 0.5rem 0;
    }

    .news-item:hover {
        background: rgba(13, 110, 253, 0.03);
        transform: translateX(8px);
        border-left: 3px solid #0d6efd;
        padding-left: 1.5rem;
    }

    .keeper-progress {
        height: 6px;
        border-radius: 3px;
        background: rgba(108, 117, 125, 0.2);
        overflow: hidden;
    }

    .keeper-progress-bar {
        height: 100%;
        border-radius: 3px;
        transition: width 0.4s ease;
    }

    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }

    .live-indicator {
        animation: pulse 2s infinite;
    }

    /* Mobile optimization for My Team Stats */
    @media (max-width: 767.98px) {
        .stat-block h6 {
            font-size: 0.75rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .stat-block .fs-4 {
            font-size: 1.1rem !important;
        }
        
        /* Shorter labels for mobile */
        .stat-block h6.mobile-short {
            font-size: 0.7rem;
        }
        
        /* Ensure stat blocks don't grow too tall */
        .stat-block {
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
    }
    
    /* Extra small devices */
    @media (max-width: 575.98px) {
        .stat-block h6 {
            font-size: 0.65rem;
        }
        
        .stat-block .fs-4 {
            font-size: 1rem !important;
        }
    }
</style>

<!-- Draft Countdown Section -->
<% 
// Check if we should show the countdown (within 7 days of draft or on draft day)
const draftDate = new Date('2025-08-31T17:30:00.000Z'); // 12:30 PM CT
const now = new Date();
const daysUntilDraft = Math.floor((draftDate - now) / (1000 * 60 * 60 * 24));
const showCountdown = daysUntilDraft <= 7 && daysUntilDraft >= 0;
const draftHasStarted = now >= draftDate;

// Common variables for dynamic messaging
const today = new Date();
const draftActualDate = new Date('2025-08-31');
const isActuallyDraftDay = today.getFullYear() === draftActualDate.getFullYear() && 
                           today.getMonth() === draftActualDate.getMonth() && 
                           today.getDate() === draftActualDate.getDate();

const tomorrow = new Date(today);
tomorrow.setDate(today.getDate() + 1);
const isActuallyTomorrow = tomorrow.getFullYear() === draftActualDate.getFullYear() && 
                           tomorrow.getMonth() === draftActualDate.getMonth() && 
                           tomorrow.getDate() === draftActualDate.getDate();

// Draft is complete - hide all draft-related messages
const isDraftComplete = true;
%>

<!-- Draft countdown section removed - draft completed -->

<script>
// Convert draft time to user's timezone and set day name
function displayLocalDraftTime() {
    const draftTimeUTC = new Date('2025-08-31T17:30:00.000Z'); // 12:30 PM CT
    
    // Format time in user's timezone
    const userTimeString = draftTimeUTC.toLocaleTimeString('en-US', {
        hour: 'numeric',
        minute: '2-digit',
        timeZoneName: 'short',
        hour12: true
    });
    
    // Get the day name dynamically
    const dayName = draftTimeUTC.toLocaleDateString('en-US', { weekday: 'long' });
    
    // Update draft day name
    const draftDayNameEl = document.getElementById('draft-day-name');
    if (draftDayNameEl) {
        draftDayNameEl.textContent = dayName;
    }
    
    // Update main draft time display
    const mainDraftTimeEl = document.getElementById('main-draft-time');
    if (mainDraftTimeEl) {
        mainDraftTimeEl.textContent = userTimeString;
    }
    
    // Update sidebar draft time displays
    const userDraftTimeEl = document.getElementById('user-draft-time');
    if (userDraftTimeEl) {
        userDraftTimeEl.textContent = userTimeString;
    }
    
    const sidebarDraftTimeEl = document.getElementById('sidebar-draft-time');
    if (sidebarDraftTimeEl) {
        sidebarDraftTimeEl.textContent = userTimeString;
    }
}

// Draft countdown timer removed - draft complete

// Draft position function removed - draft is complete

// Fetch and display the actual lineup lock time from database
async function updateWeeklyDeadline() {
    try {
        // Fetch the current/next lock time from the server
        const response = await fetch('/api/next-lineup-lock');
        const data = await response.json();
        
        if (!data.success || !data.lockTime) {
            // No lock time set, hide the countdown
            const countdownEl = document.getElementById('next-thursday-countdown');
            if (countdownEl) {
                countdownEl.textContent = 'Not set';
            }
            return;
        }
        
        // Parse the lock time from server (it's in UTC)
        const lockTime = new Date(data.lockTime);
        const now = new Date();
        const difference = lockTime - now;
        
        const countdownEl = document.getElementById('next-thursday-countdown');
        const dateEl = document.getElementById('next-thursday-date');
        
        if (difference <= 0) {
            // Deadline has passed
            if (countdownEl) {
                countdownEl.textContent = 'Locked';
            }
            return;
        }
        
        // Calculate time components
        const days = Math.floor(difference / (1000 * 60 * 60 * 24));
        const hours = Math.floor((difference / (1000 * 60 * 60)) % 24);
        const minutes = Math.floor((difference / 1000 / 60) % 60);
        const seconds = Math.floor((difference / 1000) % 60);
        
        // Update countdown display
        if (countdownEl) {
            if (days > 0) {
                countdownEl.textContent = `${days}d ${hours}h ${minutes}m ${seconds}s`;
            } else if (hours > 0) {
                countdownEl.textContent = `${hours}h ${minutes}m ${seconds}s`;
            } else if (minutes > 0) {
                countdownEl.textContent = `${minutes}m ${seconds}s`;
            } else {
                countdownEl.textContent = `${seconds} seconds`;
            }
        }
        
        // Update date display with user's local timezone
        if (dateEl) {
            const dayName = lockTime.toLocaleDateString('en-US', { weekday: 'long' });
            const dateString = lockTime.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const timeString = lockTime.toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                timeZoneName: 'short',
                hour12: true
            });
            
            // Update the date display
            dateEl.innerHTML = `${dayName}, ${dateString} at ${timeString}`;
        }
        
    } catch (error) {
        // Error fetching lineup lock time
        const countdownEl = document.getElementById('next-thursday-countdown');
        if (countdownEl) {
            countdownEl.textContent = 'Error loading';
        }
    }
}

// Draft functions removed - draft is complete

// Initialize and update weekly deadline countdown
updateWeeklyDeadline(); // Initial call
const deadlineInterval = setInterval(updateWeeklyDeadline, 1000); // Update every second
</script>

<style>
.draft-announcement-section .time-unit {
    min-width: 80px;
}

.draft-announcement-section .countdown-display {
    margin: 0 auto;
    max-width: 400px;
}

@media (max-width: 575px) {
    .draft-announcement-section .display-4 {
        font-size: 2rem;
    }
    
    .draft-announcement-section .time-unit {
        min-width: 60px;
    }
}
</style>
<!-- Draft alerts removed - draft completed -->

<div class="row">
    <!-- League News -->
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">League News</h5>
                <span class="badge bg-primary">Latest</span>
            </div>
            <div class="card-body">
                <!-- Welcome Message - First -->
                <div class="news-item mb-3 pb-3 border-bottom">
                    <h6>Welcome to the New GBRFL Website</h6>
                    <p class="text-muted mb-1"><small>Posted on March 25, 2025</small></p>
                    <p>Welcome to the new George Blanda Rotisserie Football League website! This platform will help us efficiently manage teams and rosters, conduct the draft, and more.</p>
                </div>
                
                
                <!-- Season Information -->
                <div class="news-item">
                    <h6>2025 Season Underway</h6>
                    <p class="text-muted mb-1"><small>Posted on September 4, 2025</small></p>
                    <p>The 2025 GBRFL season is now active! Manage your lineups, check the waiver wire, and prepare for weekly matchups. Good luck to all teams!</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Right Sidebar -->
    <div class="col-lg-4">
        <!-- My Team Status (Pre-Draft Only) -->
        <% if (!isDraftComplete) { %>
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">My Team Status</h5>
            </div>
            <div class="card-body">
                <% if (userTeam) { %>
                    <div class="row text-center">
                        <div class="col-12">
                            <div class="stat-block">
                                <h6 class="text-muted">Season Status</h6>
                                <span class="fs-4 fw-bold text-success">ACTIVE</span>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-3">
                    
                    <!-- Team info at bottom -->
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1"><%= userTeam.team_name %></h6>
                            <small class="text-muted"><%= userTeam.player_count %> players on roster</small>
                        </div>
                        <a href="/teams/<%= userTeam.team_id %>" class="btn btn-sm btn-outline-primary">View Team</a>
                    </div>
                <% } else { %>
                    <p class="text-muted text-center">Contact the league administrator to get assigned to a team.</p>
                <% } %>
            </div>
        </div>
        <% } %>
        
        <!-- Important Dates -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <% if (isDraftComplete) { %>
                        Weekly Deadlines
                    <% } else { %>
                        Important Dates
                    <% } %>
                </h5>
            </div>
            <div class="card-body">
                <% if (isDraftComplete) { %>
                    <!-- Post-Draft: Weekly Thursday Deadline -->
                    <div class="text-center mb-3">
                        <h6 class="text-muted mb-2">Lineup & Waiver Deadline</h6>
                        <div class="fs-5 fw-bold text-primary" id="next-thursday-countdown">
                            <span class="text-muted">Loading...</span>
                        </div>
                        <small class="text-muted d-block mt-1" id="next-thursday-date">
                            Thursday at <span id="thursday-time">7:20 PM</span>
                        </small>
                    </div>
                    <hr>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Trade Deadline
                            <% if (tradeDeadline) { %>
                                <span class="badge bg-warning text-dark"><%= new Date(tradeDeadline).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', timeZone: 'UTC' }) %></span>
                            <% } else { %>
                                <span class="badge bg-secondary text-dark">TBD</span>
                            <% } %>
                        </li>
                    </ul>
                <% } else { %>
                    <!-- Pre-Draft: Original dates -->
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Keeper Deadline
                            <% if (isKeeperPeriodActive) { %>
                                <span class="badge bg-warning text-dark">Aug 24, 2025</span>
                            <% } else { %>
                                <span class="badge bg-secondary">Closed</span>
                            <% } %>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Draft Date
                            <% if (isActuallyDraftDay) { %>
                                <span class="badge bg-success live-indicator">TODAY - <span id="sidebar-draft-time">12:30 PM</span></span>
                            <% } else if (isActuallyTomorrow) { %>
                                <span class="badge bg-warning text-dark">TOMORROW - <span id="sidebar-draft-time">12:30 PM</span></span>
                            <% } else { %>
                                <span class="badge bg-info text-dark">Aug 31, 2025 - <span id="sidebar-draft-time">12:30 PM</span></span>
                            <% } %>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Season Start
                            <span class="badge bg-success">Sep 4, 2025</span>
                        </li>
                    </ul>
                <% } %>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <!-- Conditional keeper management button -->
                    <% if (userTeam && isKeeperPeriodActive) { %>
                        <a href="/keepers/<%= userTeam.team_id %>"
                           class="btn btn-success">
                            <i class="bi bi-shield-check"></i> <%= locals.isGuest ? 'View' : 'Manage' %> Keepers
                        </a>
                    <% } %>

                    <!-- Draft room button (only on draft day, not for guests) -->
                    <% if (isDraftDay && !locals.isGuest) { %>
                        <a href="/draft" class="btn btn-primary">
                            <i class="bi bi-calendar-event"></i> Join Draft Room
                        </a>
                    <% } %>

                    <a href="/players" class="btn btn-outline-primary">
                        <i class="bi bi-person-plus"></i> Browse Available Players
                    </a>

                    <% if (!locals.isGuest) { %>
                    <a href="/trades/new" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left-right"></i> Propose a Trade
                    </a>
                    <a href="/message-board" class="btn btn-outline-dark">
                        <i class="bi bi-chat-square-text"></i> Create Forum Post
                    </a>
                    <% } else { %>
                    <a href="/message-board" class="btn btn-outline-dark">
                        <i class="bi bi-chat-square-text"></i> View Message Board
                    </a>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Dashboard-specific JavaScript -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle keeper scroll on mobile
        const keeperBtn = document.querySelector('.keeper-scroll-btn');
        if (keeperBtn) {
            keeperBtn.addEventListener('click', function(e) {
                // Check if mobile (768px breakpoint)
                if (window.innerWidth <= 768) {
                    e.preventDefault();
                    
                    // Navigate to team page with hash for mobile scroll
                    const teamId = this.href.split('/teams/')[1].split('#')[0];
                    window.location.href = `/teams/${teamId}#keepers`;
                }
                // On desktop, let the link work normally
            });
        }

    });
</script>