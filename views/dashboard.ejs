<!-- Enhanced CSS for Dashboard -->
<style>
    .stat-block {
        padding: 1.25rem;
        border-radius: 12px;
        background: linear-gradient(135deg, rgba(13, 110, 253, 0.08), rgba(13, 110, 253, 0.03));
        transition: all 0.3s ease;
        cursor: pointer;
        border: 1px solid rgba(13, 110, 253, 0.15);
        position: relative;
        overflow: hidden;
    }

    .stat-block::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #0d6efd, #6610f2);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .stat-block:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 25px rgba(13, 110, 253, 0.2);
        background: linear-gradient(135deg, rgba(13, 110, 253, 0.12), rgba(13, 110, 253, 0.06));
        border-color: rgba(13, 110, 253, 0.3);
    }

    .stat-block:hover::before {
        opacity: 1;
    }

    .news-item {
        transition: all 0.2s ease;
        padding: 1rem;
        border-radius: 8px;
        margin: 0.5rem 0;
    }

    .news-item:hover {
        background: rgba(13, 110, 253, 0.03);
        transform: translateX(8px);
        border-left: 3px solid #0d6efd;
        padding-left: 1.5rem;
    }

    .keeper-progress {
        height: 6px;
        border-radius: 3px;
        background: rgba(108, 117, 125, 0.2);
        overflow: hidden;
    }

    .keeper-progress-bar {
        height: 100%;
        border-radius: 3px;
        transition: width 0.4s ease;
    }

    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }

    .live-indicator {
        animation: pulse 2s infinite;
    }

    /* Mobile optimization for My Team Stats */
    @media (max-width: 767.98px) {
        .stat-block h6 {
            font-size: 0.75rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .stat-block .fs-4 {
            font-size: 1.1rem !important;
        }
        
        /* Shorter labels for mobile */
        .stat-block h6.mobile-short {
            font-size: 0.7rem;
        }
        
        /* Ensure stat blocks don't grow too tall */
        .stat-block {
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
    }
    
    /* Extra small devices */
    @media (max-width: 575.98px) {
        .stat-block h6 {
            font-size: 0.65rem;
        }
        
        .stat-block .fs-4 {
            font-size: 1rem !important;
        }
    }
</style>

<!-- Draft Countdown Section -->
<% 
// Check if we should show the countdown (within 7 days of draft or on draft day)
const draftDate = new Date('2025-08-31T17:30:00.000Z'); // 12:30 PM CT
const now = new Date();
const daysUntilDraft = Math.floor((draftDate - now) / (1000 * 60 * 60 * 24));
const showCountdown = daysUntilDraft <= 7 && daysUntilDraft >= 0;
const draftHasStarted = now >= draftDate;
%>

<% if (showCountdown && !draftHasStarted) { %>
<div class="draft-announcement-section mb-4">
    <div class="card border-primary shadow-lg">
        <div class="card-body text-center py-4" style="background: linear-gradient(135deg, rgba(13, 110, 253, 0.1), rgba(102, 16, 242, 0.05));">
            <h2 class="mb-3">
                <i class="bi bi-calendar-event-fill text-primary"></i> 
                Live Draft Information
            </h2>
            <p class="lead mb-4">
                <strong>Draft starts <span id="draft-day-name">Sunday</span>, August 31st at <span id="main-draft-time">12:30 PM CT</span></strong>
            </p>
            
            <div id="draft-countdown" class="mb-4">
                <div class="countdown-display d-flex justify-content-center gap-3">
                    <div class="time-unit text-center">
                        <div class="display-4 fw-bold text-primary" id="days">0</div>
                        <small class="text-muted">Days</small>
                    </div>
                    <div class="time-unit text-center">
                        <div class="display-4 fw-bold text-primary" id="hours">0</div>
                        <small class="text-muted">Hours</small>
                    </div>
                    <div class="time-unit text-center">
                        <div class="display-4 fw-bold text-primary" id="minutes">0</div>
                        <small class="text-muted">Minutes</small>
                    </div>
                    <div class="time-unit text-center">
                        <div class="display-4 fw-bold text-primary" id="seconds">0</div>
                        <small class="text-muted">Seconds</small>
                    </div>
                </div>
            </div>
            
            <div class="draft-actions">
                <a href="/draft" class="btn btn-primary btn-lg px-4">
                    <i class="bi bi-door-open-fill"></i> Enter Draft Room
                </a>
                <p class="text-muted mt-2 mb-0">
                    <small>You can preview the draft room anytime before the draft starts</small>
                </p>
            </div>
        </div>
    </div>
</div>

<script>
// Convert draft time to user's timezone and set day name
function displayLocalDraftTime() {
    const draftTimeUTC = new Date('2025-08-31T17:30:00.000Z'); // 12:30 PM CT
    
    // Format time in user's timezone
    const userTimeString = draftTimeUTC.toLocaleTimeString('en-US', {
        hour: 'numeric',
        minute: '2-digit',
        timeZoneName: 'short',
        hour12: true
    });
    
    // Get the day name dynamically
    const dayName = draftTimeUTC.toLocaleDateString('en-US', { weekday: 'long' });
    
    // Update draft day name
    const draftDayNameEl = document.getElementById('draft-day-name');
    if (draftDayNameEl) {
        draftDayNameEl.textContent = dayName;
    }
    
    // Update main draft time display
    const mainDraftTimeEl = document.getElementById('main-draft-time');
    if (mainDraftTimeEl) {
        mainDraftTimeEl.textContent = userTimeString;
    }
    
    // Update sidebar draft time displays
    const userDraftTimeEl = document.getElementById('user-draft-time');
    if (userDraftTimeEl) {
        userDraftTimeEl.textContent = userTimeString;
    }
    
    const sidebarDraftTimeEl = document.getElementById('sidebar-draft-time');
    if (sidebarDraftTimeEl) {
        sidebarDraftTimeEl.textContent = userTimeString;
    }
}

// Draft countdown timer
function updateDraftCountdown() {
    const draftTime = new Date('2025-08-31T17:30:00.000Z'); // 12:30 PM CT
    const now = new Date();
    const difference = draftTime - now;
    
    if (difference <= 0) {
        document.getElementById('draft-countdown').innerHTML = 
            '<div class="alert alert-success mb-0"><h3 class="mb-0">üî¥ DRAFT IS LIVE NOW!</h3></div>';
        // Stop the countdown
        clearInterval(countdownInterval);
        return;
    }
    
    const days = Math.floor(difference / (1000 * 60 * 60 * 24));
    const hours = Math.floor((difference / (1000 * 60 * 60)) % 24);
    const minutes = Math.floor((difference / 1000 / 60) % 60);
    const seconds = Math.floor((difference / 1000) % 60);
    
    document.getElementById('days').textContent = days;
    document.getElementById('hours').textContent = hours.toString().padStart(2, '0');
    document.getElementById('minutes').textContent = minutes.toString().padStart(2, '0');
    document.getElementById('seconds').textContent = seconds.toString().padStart(2, '0');
}

// Fetch user's draft position from the draft order
async function loadDraftPosition() {
    try {
        const response = await fetch('/admin/draft-order/data');
        const data = await response.json();
        
        if (data.success) {
            // Find current user's team draft position (from round 1)
            const userTeamId = <%= user.team_id || 'null' %>;
            if (userTeamId) {
                const round1Picks = data.draftOrder.filter(pick => pick.round === 1);
                const userPick = round1Picks.find(pick => pick.original_team_id === userTeamId);
                
                const draftPositionEl = document.getElementById('user-draft-position');
                if (draftPositionEl && userPick) {
                    draftPositionEl.innerHTML = `<span class="text-primary">#${userPick.pick_number}</span>`;
                } else if (draftPositionEl) {
                    draftPositionEl.innerHTML = '<span class="text-muted">TBD</span>';
                }
            }
        }
    } catch (error) {
        console.error('Error loading draft position:', error);
        const draftPositionEl = document.getElementById('user-draft-position');
        if (draftPositionEl) {
            draftPositionEl.innerHTML = '<span class="text-muted">TBD</span>';
        }
    }
}

// Initialize timezone display, countdown, and draft position
displayLocalDraftTime();
loadDraftPosition();

// Update every second
const countdownInterval = setInterval(updateDraftCountdown, 1000);
updateDraftCountdown(); // Initial call
</script>

<style>
.draft-announcement-section .time-unit {
    min-width: 80px;
}

.draft-announcement-section .countdown-display {
    margin: 0 auto;
    max-width: 400px;
}

@media (max-width: 575px) {
    .draft-announcement-section .display-4 {
        font-size: 2rem;
    }
    
    .draft-announcement-section .time-unit {
        min-width: 60px;
    }
}
</style>
<% } else if (draftHasStarted) { %>
<div class="alert alert-success text-center mb-4">
    <h3 class="mb-2">üèà Draft Has Started!</h3>
    <a href="/draft" class="btn btn-success btn-lg">
        <i class="bi bi-door-open-fill"></i> Join Draft Room Now
    </a>
</div>
<% } %>

<div class="row">
    <!-- League News -->
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">League News</h5>
                <span class="badge bg-primary">Latest</span>
            </div>
            <div class="card-body">
                <!-- Welcome Message - First -->
                <div class="news-item mb-3 pb-3 border-bottom">
                    <h6>Welcome to the New GBRFL Website</h6>
                    <p class="text-muted mb-1"><small>Posted on March 25, 2025</small></p>
                    <p>Welcome to the new George Blanda Rotisserie Football League website! This platform will help us efficiently manage teams and rosters, conduct the draft, and more.</p>
                </div>
                
                <!-- Keeper Selection - Second -->
                <div class="news-item mb-3 pb-3 border-bottom">
                    <h6>Keeper Selection Period Now Open</h6>
                    <p class="text-muted mb-1"><small>Posted on April 10, 2025</small></p>
                    <p>The keeper selection period is now open. Teams can protect players based on their available protection spots. The deadline for keeper selections is August 24, 2025.</p>
                </div>
                
                <!-- Draft Information - Third -->
                <div class="news-item">
                    <h6>Draft Day Approaching</h6>
                    <p class="text-muted mb-1"><small>Posted on August 15, 2025</small></p>
                    <% if (isDraftDay) { %>
                        <p>The 2025 GBRFL Draft is happening today! Access the draft room below when you're ready to participate.</p>
                        <a href="/draft" class="btn btn-success mt-2">
                            <i class="bi bi-calendar-event"></i> Join Draft Room
                        </a>
                    <% } else if (daysUntilDraft === 1) { %>
                        <p>The 2025 GBRFL Draft is tomorrow, August 31st! The draft room is ready for preview. Make sure you're prepared!</p>
                        <a href="/draft" class="btn btn-primary mt-2">
                            <i class="bi bi-eye"></i> Preview Draft Room
                        </a>
                    <% } else { %>
                        <p>The 2025 GBRFL Draft is scheduled for August 31, 2025. Keeper selections closed on August 24th. Draft room access will be available on draft day.</p>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Right Sidebar -->
    <div class="col-lg-4">
        <!-- My Team Status -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">My Team Status</h5>
            </div>
            <div class="card-body">
                <% if (userTeam) { %>
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="stat-block">
                                <h6 class="text-muted">
                                    <span class="d-none d-sm-inline">Draft Position</span>
                                    <span class="d-sm-none">Draft Pos</span>
                                </h6>
                                <span class="fs-4 fw-bold" id="user-draft-position">
                                    <span class="text-muted">Loading...</span>
                                </span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-block">
                                <h6 class="text-muted">
                                    <span class="d-none d-sm-inline">Days to Draft</span>
                                    <span class="d-sm-none">Draft Days</span>
                                </h6>
                                <span class="fs-4 fw-bold text-info">
                                    <% if (isDraftDay) { %>
                                        <span class="live-indicator">1</span>
                                    <% } else if (daysUntilDraft <= 0) { %>
                                        COMPLETE
                                    <% } else { %>
                                        <%= daysUntilDraft %>
                                    <% } %>
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-3">
                    
                    <!-- Team info at bottom -->
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1"><%= userTeam.team_name %></h6>
                            <small class="text-muted"><%= userTeam.player_count %> players on roster</small>
                        </div>
                        <a href="/teams/<%= userTeam.team_id %>" class="btn btn-sm btn-outline-primary">View Team</a>
                    </div>
                <% } else { %>
                    <p class="text-muted text-center">Contact the league administrator to get assigned to a team.</p>
                <% } %>
            </div>
        </div>
        
        <!-- Important Dates -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Important Dates</h5>
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Keeper Deadline
                        <% if (isKeeperPeriodActive) { %>
                            <span class="badge bg-warning text-dark">Aug 24, 2025</span>
                        <% } else { %>
                            <span class="badge bg-secondary">Closed</span>
                        <% } %>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Draft Date
                        <% if (isDraftDay) { %>
                            <span class="badge bg-success live-indicator">TODAY - <span id="sidebar-draft-time">12:30 PM</span></span>
                        <% } else if (daysUntilDraft === 1) { %>
                            <span class="badge bg-warning text-dark">TOMORROW - <span id="sidebar-draft-time">12:30 PM</span></span>
                        <% } else { %>
                            <span class="badge bg-info text-dark">Aug 31, 2025 - <span id="sidebar-draft-time">12:30 PM</span></span>
                        <% } %>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Season Start
                        <span class="badge bg-success">Sep 4, 2025</span>
                    </li>
                </ul>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <!-- Conditional keeper management button -->
                    <% if (userTeam && isKeeperPeriodActive) { %>
                        <a href="/keepers/<%= userTeam.team_id %>" 
                           class="btn btn-success">
                            <i class="bi bi-shield-check"></i> Manage Keepers
                        </a>
                    <% } %>
                    
                    <!-- Draft room button (only on draft day) -->
                    <% if (isDraftDay) { %>
                        <a href="/draft" class="btn btn-primary">
                            <i class="bi bi-calendar-event"></i> Join Draft Room
                        </a>
                    <% } %>
                    
                    <a href="/players" class="btn btn-outline-primary">
                        <i class="bi bi-person-plus"></i> Browse Available Players
                    </a>
                    <a href="/trades/new" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left-right"></i> Propose a Trade
                    </a>
                    <a href="/message-board" class="btn btn-outline-dark">
                        <i class="bi bi-chat-square-text"></i> Create Forum Post
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Dashboard-specific JavaScript -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle keeper scroll on mobile
        const keeperBtn = document.querySelector('.keeper-scroll-btn');
        if (keeperBtn) {
            keeperBtn.addEventListener('click', function(e) {
                // Check if mobile (768px breakpoint)
                if (window.innerWidth <= 768) {
                    e.preventDefault();
                    
                    // Navigate to team page with hash for mobile scroll
                    const teamId = this.href.split('/teams/')[1].split('#')[0];
                    window.location.href = `/teams/${teamId}#keepers`;
                }
                // On desktop, let the link work normally
            });
        }

    });
</script>